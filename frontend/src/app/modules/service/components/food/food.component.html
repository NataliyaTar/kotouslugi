@if (loading) {
  <app-throbber></app-throbber>
    } @else {
  <div class="fields-wrapper" [formGroup]="form">
    <!-- Шаг 1: Информация о коте -->
  <div class="field-wrapper" [hidden]="active !== 0" formGroupName="0">
    <h3 class="step-title">Информация о коте</h3>
  <p class="step-description">Выберите кота и укажите контактные данные</p>

  <div class="field">
    <div>
    <p class="label">Выберите кота</p>
    @if (getControl(0, 'cat').errors?.['required'] && getControl(0, 'cat').touched) {
  <p class="error">Поле обязательно для заполнения</p>
  }
  </div>
  <select formControlName="cat">
  @for (option of optionsCat; track $index) {
  <option [value]="getItem('cat', $index)">{{option.text}}</option>
  }
  </select>
  </div>

  <div class="field">
  <div>
  <p class="label">Имя владельца</p>
  @if (getControl(0, 'ownerName').errors?.['required'] && getControl(0, 'ownerName').touched) {
<p class="error">Поле обязательно для заполнения</p>
}
</div>
<input formControlName="ownerName" placeholder="Ваше имя">
</div>

<div class="field">
<div>
<p class="label">Телефон для связи</p>
@if (getControl(0, 'telephone').errors && getControl(0, 'telephone').touched) {
@if (getControl(0, 'telephone').errors?.['required']) {
  <p class="error">Поле обязательно для заполнения</p>
    }
    @if (getControl(0, 'telephone').errors?.['pattern']) {
  <p class="error">Введите 11 цифр</p>
    }
    }
    </div>
  <input formControlName="telephone" placeholder="12345678901">
    </div>

    <div class="field">
    <div>
    <p class="label">Email для связи</p>
    @if (getControl(0, 'email').errors && getControl(0, 'email').touched) {
  @if (getControl(0, 'email').errors?.['required']) {
    <p class="error">Поле обязательно для заполнения</p>
      }
      @if (getControl(0, 'email').errors?.['email']) {
    <p class="error">Введите корректный email</p>
      }
  }
  </div>
  <input formControlName="email" type="email" placeholder="abc@example.com">
  </div>
  </div>

  <!-- Шаг 2: Адрес доставки -->
  <div class="field-wrapper" [hidden]="active !== 1" formGroupName="1">
  <h3 class="step-title">Адрес доставки</h3>
  <p class="step-description">Укажите адрес для доставки заказа</p>

  <div class="field">
  <div>
  <p class="label">Город</p>
  @if (getControl(1, 'city').errors?.['required'] && getControl(1, 'city').touched) {
<p class="error">Поле обязательно для заполнения</p>
}
</div>
<select formControlName="city" (change)="onCitySelect($any($event.target).value)">
<option value="">Выберите город</option>
@for (city of cityOptions; track $index) {
<option [value]="city.id">{{city.name}}</option>
}
</select>
</div>

<div class="field">
<div>
<p class="label">Улица</p>
@if (getControl(1, 'street').errors?.['required'] && getControl(1, 'street').touched) {
<p class="error">Поле обязательно для заполнения</p>
}
</div>
<select formControlName="street" [disabled]="!streetOptions.length">
<option value="">Выберите улицу</option>
@for (street of streetOptions; track $index) {
<option [value]="street.id">{{street.name}}</option>
}
</select>
</div>

<div class="field">
<div>
<p class="label">Дом</p>
@if (getControl(1, 'house').errors && getControl(1, 'house').touched) {
@if (getControl(1, 'house').errors?.['required']) {
  <p class="error">Поле обязательно для заполнения</p>
    }
    @if (getControl(1, 'house').errors?.['positive']) {
  <p class="error">Введите положительное число</p>
    }
    }
    </div>
  <input formControlName="house" type="number" placeholder="Номер дома">
    </div>

    <div class="field">
    <div>
    <p class="label">Квартира (необязательно)</p>
    @if (getControl(1, 'apartment').errors?.['positive'] && getControl(1, 'apartment').touched) {
  <p class="error">Введите положительное число</p>
  }
  </div>
  <input formControlName="apartment" type="number" placeholder="Номер квартиры">
  </div>
  </div>

  <!-- Шаг 3: Детали заказа -->
  <div class="field-wrapper" [hidden]="active !== 2" formGroupName="2">
  <h3 class="step-title">Детали заказа</h3>
  <p class="step-description">Выберите магазин, продукты и время доставки</p>

<div class="field">
<div>
<p class="label">Магазин</p>
@if (getControl(2, 'shop').errors?.['required'] && getControl(2, 'shop').touched) {
<p class="error">Поле обязательно для заполнения</p>
}
</div>
<select formControlName="shop">
<option value="">Выберите магазин</option>
@for (shop of shopOptions; track $index) {
<option [value]="shop.id">{{shop.name}}</option>
}
</select>
</div>

<div class="field">
<div>
<p class="label">Тип доставки</p>
@if (getControl(2, 'deliveryType').errors?.['required'] && getControl(2, 'deliveryType').touched) {
<p class="error">Поле обязательно для заполнения</p>
}
</div>
<select formControlName="deliveryType">
<option value="delivery">Доставка</option>
<option value="pickup">Самовывоз</option>
</select>
</div>

<div class="field">
<div>
<p class="label">Дата доставки</p>
@if (getControl(2, 'deliveryDate').errors && getControl(2, 'deliveryDate').touched) {
@if (getControl(2, 'deliveryDate').errors?.['required']) {
  <p class="error">Поле обязательно для заполнения</p>
    }
    @if (getControl(2, 'deliveryDate').errors?.['minDate']) {
  <p class="error">Выберите дату в будущем</p>
    }
    }
    </div>
  <input formControlName="deliveryDate" type="date">
    </div>

    <div class="field">
    <div>
    <p class="label">Время доставки (необязательно)</p>
  </div>
  <input formControlName="deliveryTime" type="time">
    </div>
    </div>

    <!-- Шаг 4: Выбор товаров -->
  <div class="field-wrapper" [hidden]="active !== 3" formGroupName="3">
    <h3 class="step-title">Выбор товаров</h3>
  <p class="step-description">Выберите товары для заказа</p>

  <div class="field">
    <div>
    <p class="label">Товары</p>
    @if (getControl(3, 'products').errors && getControl(3, 'products').touched) {
  @if (getControl(3, 'products').errors?.['required']) {
    <p class="error">Выберите хотя бы один товар</p>
      }
  }
  </div>

  <div class="products-grid">
  @for (product of productOptions; track product.id) {
  <div class="product-card"
       [class.selected]="isProductSelected(product)"
       (click)="toggleProduct(product)">
    @if (product.image) {
    <img [src]="product.image" [alt]="product.name" class="product-image">
    }
    <div class="product-info">
      <h4>{{product.name}}</h4>
      <p class="description">{{product.description}}</p>
      <p class="price">{{product.price}}₽</p>
    </div>
  </div>
  }
  </div>

  @if (selectedProducts.length > 0) {
  <div class="selected-products">
    <h4>Выбранные товары:</h4>
    <ul>
      @for (product of selectedProducts; track product.id) {
      <li>{{product.name}} - {{product.price}}₽</li>
      }
    </ul>
    <p class="total-price">Итого: {{getTotalPrice()}}₽</p>
  </div>
  }
  </div>
  </div>

  <!-- Шаг 5: Комментарий -->
  <div class="field-wrapper" [hidden]="active !== 4" formGroupName="4">
  <h3 class="step-title">Комментарий</h3>
  <p class="step-description">Добавьте комментарий к заказу (необязательно)</p>

  <div class="field">
  <div>
  <p class="label">Комментарий</p>
  </div>
  <textarea formControlName="comment" placeholder="Ваши пожелания"></textarea>
  </div>
  </div>

  <!-- Шаг 6: Проверка информации -->
  @if (active === 5) {
  <div class="confirmation-wrapper">
    <h3 class="step-title">Проверка информации</h3>
    <p class="step-description">Проверьте заявку на корректность данных</p>

    <app-check-info [data]="getResult"></app-check-info>
  </div>
  }
  </div>
  }
